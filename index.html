<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Script Viewer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #222;
      color: white;
      overflow: hidden;
    }
    #viewer {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    canvas {
      width: 100%;
      height: 100%;
    }
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
    button {
      margin-left: 5px;
    }
    .note {
      position: absolute;
      background: yellow;
      padding: 4px;
      border: 1px solid black;
      resize: both;
      overflow: auto;
      cursor: move;
      z-index: 20;
    }
    .note textarea {
      width: 120px;
      height: 60px;
      resize: none;
    }
    .note button {
      margin: 2px 0 0 2px;
    }
    .arrow {
      position: absolute;
      pointer-events: none;
      z-index: 15;
    }
    svg {
      position: absolute;
      overflow: visible;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="viewer">
    <canvas id="pdf-canvas"></canvas>
    <div id="controls">
      <button onclick="prevPage()">‚ü®</button>
      <button onclick="nextPage()">‚ü©</button>
      <button onclick="addNote()">‚ûï Note</button>
      <button onclick="toggleFullscreen()">‚õ∂</button>
    </div>
  </div>

  <input type="file" id="file-input" accept="application/pdf">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    let pdfDoc = null, currentPage = 1;
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const viewer = document.getElementById('viewer');
    let notes = JSON.parse(localStorage.getItem("pdfNotes") || "{}");
    let arrowTargeting = null;

    document.getElementById('file-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      const fileURL = URL.createObjectURL(file);
      const loadingTask = pdfjsLib.getDocument(fileURL);
      pdfDoc = await loadingTask.promise;
      currentPage = 1;
      renderPage();
    });

    function renderPage() {
      if (!pdfDoc) return;
      pdfDoc.getPage(currentPage).then(page => {
        const viewport = page.getViewport({ scale: 2 });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const renderContext = { canvasContext: ctx, viewport };
        page.render(renderContext).promise.then(() => {
          renderNotesForSpread();
        });
      });
    }

    function nextPage() {
      if (currentPage < pdfDoc.numPages) {
        currentPage++;
        renderPage();
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderPage();
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        viewer.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    function saveNotes() {
      localStorage.setItem("pdfNotes", JSON.stringify(notes));
    }

    function addNote() {
      const key = currentPage;
      if (!notes[key]) notes[key] = [];

      const note = {
        x: 100, y: 100, w: 150, h: 80, text: "Note", arrow: null
      };
      notes[key].push(note);
      saveNotes();
      renderNotesForSpread();
    }

    function renderNotesForSpread() {
      document.querySelectorAll(".note, svg.arrow").forEach(el => el.remove());

      const key = currentPage;
      if (!notes[key]) return;

      notes[key].forEach(note => {
        const noteDiv = document.createElement("div");
        noteDiv.className = "note";
        noteDiv.style.left = note.x + "px";
        noteDiv.style.top = note.y + "px";
        noteDiv.style.width = note.w + "px";
        noteDiv.style.height = note.h + "px";
        noteDiv.onclick = e => e.stopPropagation();

        const textArea = document.createElement("textarea");
        textArea.value = note.text;
        textArea.oninput = () => {
          note.text = textArea.value;
          saveNotes();
        };
        textArea.onclick = e => e.stopPropagation();

        const targetBtn = document.createElement("button");
        targetBtn.innerText = "üéØ";
        targetBtn.onclick = e => {
          e.stopPropagation();
          arrowTargeting = note;
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.innerText = "üóëÔ∏è";
        deleteBtn.onclick = e => {
          e.stopPropagation();
          const index = notes[key].indexOf(note);
          if (index > -1) {
            notes[key].splice(index, 1);
            saveNotes();
            renderNotesForSpread();
          }
        };

        noteDiv.appendChild(textArea);
        noteDiv.appendChild(targetBtn);
        noteDiv.appendChild(deleteBtn);

        makeDraggable(noteDiv, note);
        viewer.appendChild(noteDiv);

        if (note.arrow) {
          drawArrow(noteDiv, note.arrow.x, note.arrow.y);
        }
      });
    }

    function drawArrow(fromDiv, x, y) {
      const fromRect = fromDiv.getBoundingClientRect();
      const viewerRect = viewer.getBoundingClientRect();
      const x1 = fromRect.left + fromRect.width / 2 - viewerRect.left;
      const y1 = fromRect.top + fromRect.height / 2 - viewerRect.top;
      const x2 = x;
      const y2 = y;

      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.classList.add("arrow");
      svg.style.left = "0px";
      svg.style.top = "0px";
      svg.setAttribute("width", viewer.clientWidth);
      svg.setAttribute("height", viewer.clientHeight);

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", x1);
      line.setAttribute("y1", y1);
      line.setAttribute("x2", x2);
      line.setAttribute("y2", y2);
      line.setAttribute("stroke", "red");
      line.setAttribute("stroke-width", "2");
      line.setAttribute("marker-end", "url(#arrowhead)");

      const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
      const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
      marker.setAttribute("id", "arrowhead");
